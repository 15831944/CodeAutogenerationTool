using CodeAutogenerationTool.Models;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Windows.Forms;
using System.Xml.Linq;
using CodeAutogenerationTool.Helper;

namespace CodeAutogenerationTool.MForm
{
    public partial class MainForm : Form
    {
        #region 全局属性定义

        List<ListItem> dataBaseTypeItems = new List<ListItem>()
        {
            new ListItem(){ Text = "Microsoft SQL Server", Value = "0" }
        };//数据库类型
        string configPath = "../../App_Data/CodeAutogenerationTool.xml";//配置文件路径
        string connStr = "";//数据库连接字符串
        SqlConnection conn = null;//数据库连接
        delegate void connDelegate();

        #endregion

        public MainForm()
        {
            InitializeComponent();
        }

        //窗体加载事件
        private void MainForm_Load(object sender, EventArgs e)
        {
            //数据库类型添加
            foreach (var item in dataBaseTypeItems)
            {
                cbb_DataBaseType.Items.Add(item);
            }
            cbb_DataBaseType.SelectedIndex = 0;

            //加载保存过的数据
            LoadConfiguration();

            //代码生成项赋值
            cbb_Mode.Items.Add(new ListItem() { Text = "生成MVC中的MC", Value = "MC" });
            cbb_Mode.Items.Add(new ListItem() { Text = "生成三层中的DAL", Value = "DAL" });
            cbb_Mode.Items.Add(new ListItem() { Text = "生成Model", Value = "Model" });
            cbb_Mode.SelectedIndex = 0;
        }

        //选择生成路径按钮
        private void btn_SelectPath_Click(object sender, EventArgs e)
        {
            FolderBrowserDialog folderBrowserDialog = new FolderBrowserDialog();
            if (folderBrowserDialog.ShowDialog() == DialogResult.OK)
            {
                txt_Path.Text = folderBrowserDialog.SelectedPath;
            }
        }

        //连接至数据库
        private void btn_Connect_Click(object sender, EventArgs e)
        {
            //保存配置文件
            Thread thread = new Thread(ConnectionDataBase);
            string[] config = new string[] { cbb_DataBaseType.Text, txt_Ip.Text, txt_UserName.Text, txt_Pwd.Text, txt_DataBaseName.Text, txt_NameSpace.Text, txt_Path.Text };
            IsConfigExist(true, config);
            btn_Connect.Enabled = false;
            tsbtn_Connect.Enabled = false;
            tsbtn_Disconnect.Enabled = true;
            btn_Connect.Text = "连接中...";
            thread.Start();
        }

        //连接远程服务器注意提醒
        private void lbl_Tips_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            MessageBox.Show("1.需要在数据库配置中打开TCP/IP协议, 端口如果不是1433则在填写ip地址中加入端口号例如:XXX.XXX.XXX.XXX,端口号\n2.数据库需要允许远程连接\n3.用户名访问数据库权限\n4.如连接失败请查看日志");
        }

        //断开数据库连接
        private void btn_Close_Click(object sender, EventArgs e)
        {
            cbb_DataBaseType.Enabled = true;
            txt_Ip.Enabled = true;
            txt_NameSpace.Enabled = true;
            txt_Path.Enabled = true;
            txt_Pwd.Enabled = true;
            txt_UserName.Enabled = true;
            btn_Connect.Enabled = true;
            conn.Close();
            btn_Connect.Text = "连接";
            btn_Close.Enabled = false;
            txt_DataBaseName.Enabled = true;
            btn_SelectPath.Enabled = true;
            cbb_Tables.DataSource = null;
            dgv_TableDetails.DataSource = null;
            tsbtn_Connect.Enabled = true;
            tsbtn_Disconnect.Enabled = false;
            txt_Msg.Text += DateTime.Now + " 断开连接\r\n";
        }

        //读取表的信息
        private void btn_Read_Click(object sender, EventArgs e)
        {
            if (conn.State == ConnectionState.Open)
            {
                if (string.IsNullOrEmpty(cbb_Tables.Text))
                {
                    MessageBox.Show("请先选择需要读取的数据表!");
                    return;
                }
                //查询表信息sql语句
                string sqlStr = string.Format(@"SELECT  col.colorder AS 序号 ,
                col.name AS 字段名称 ,
                ISNULL(ep.[value], '') AS 字段说明 ,
                t.name AS 字段类型 ,
                col.length AS 字段长度 ,
                CASE WHEN EXISTS ( SELECT   1
                FROM     dbo.sysindexes si
                INNER JOIN dbo.sysindexkeys sik ON si.id = sik.id
                AND si.indid = sik.indid
                INNER JOIN dbo.syscolumns sc ON sc.id = sik.id
                AND sc.colid = sik.colid
                INNER JOIN dbo.sysobjects so ON so.name = si.name
                AND so.xtype = 'PK'
                WHERE    sc.id = col.id
                AND sc.colid = col.colid ) THEN '√' ELSE '' END AS 是否主键 ,
                CASE WHEN col.isnullable = 1 THEN '√' ELSE '' END AS 能否为空 ,
                ISNULL(comm.text, '') AS 默认值
                FROM    dbo.syscolumns col
                LEFT  JOIN dbo.systypes t ON col.xtype = t.xusertype
                inner JOIN dbo.sysobjects obj ON col.id = obj.id
                AND obj.xtype = 'U'
                AND obj.status >= 0
                LEFT  JOIN dbo.syscomments comm ON col.cdefault = comm.id
                LEFT  JOIN sys.extended_properties ep ON col.id = ep.major_id
                AND col.colid = ep.minor_id
                AND ep.name = 'MS_Description'
                LEFT  JOIN sys.extended_properties epTwo ON obj.id = epTwo.major_id
                AND epTwo.minor_id = 0
                AND epTwo.name = 'MS_Description'
                WHERE   obj.name = '{0}'
                ORDER BY col.colorder ;", cbb_Tables.Text);
                SqlDataAdapter dataAdapter = new SqlDataAdapter(sqlStr, conn);
                DataTable dt = new DataTable();
                dataAdapter.Fill(dt);
                dataAdapter.Dispose();
                dgv_TableDetails.DataSource = dt;
            }
            else
            {
                MessageBox.Show("与数据库断开连接, 请尝试断开重新连接!");
            }
        }

        //生成代码
        private void btn_Generate_Click(object sender, EventArgs e)
        {
            if (dgv_TableDetails.Rows.Count < 1)
            {
                MessageBox.Show("没有数据能够生成");
            }
            else if (conn == null || conn.State != ConnectionState.Open)
            {
                MessageBox.Show("与数据库的连接已经断开, 请尝试断开后重新连接");
            }
            else
            {

            }
        }

        //退出
        private void MenuItem_Exit_Click(object sender, EventArgs e)
        {
            if (conn != null && conn.State == ConnectionState.Open)
            {
                conn.Close();
            }
            Application.Exit();
        }

        //退出
        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (MessageBox.Show("是否退出?", "提醒", MessageBoxButtons.OKCancel) == DialogResult.OK)
            {
                if (conn != null && conn.State == ConnectionState.Open)
                {
                    conn.Close();
                }
            }
            else
            {
                e.Cancel = true;
            }
        }

        #region 菜单事件

        //帮助
        private void MenuItem_Help_Click(object sender, EventArgs e)
        {
            string msg = "1.选择数据库类型 \n2.输入数据库所在IP地址及登录用户名和密码(如是本机则一般为127.0.0.1), 连接\n3.连接失败请查看日志, 连接成功选择对应需要生成代码的数据库,确定";

            MessageBox.Show(msg);
        }

        #endregion

        #region 自定义方法

        /// <summary>
        /// 加载配置文件
        /// </summary>
        private void LoadConfiguration()
        {
            //验证配置文件是否存在
            IsConfigExist(false);
            XDocument xml = XDocument.Load(configPath);
            XElement root = xml.Root;//获取xml根元素
            IEnumerable<XElement> elements = root.Element("appSettings").Elements("add");

            foreach (var item in elements)
            {
                switch (item.Attribute("key").Value)
                {
                    case "Server.Type":
                        if (dataBaseTypeItems.Where(p => p.Text == item.Attribute("value").Value).Count() > 0)
                            cbb_DataBaseType.SelectedItem = dataBaseTypeItems.Single(p => p.Text == item.Attribute("value").Value);
                        break;
                    case "Server.Ip":
                        txt_Ip.Text = item.Attribute("value").Value;
                        break;
                    case "Server.UserName":
                        txt_UserName.Text = item.Attribute("value").Value;
                        break;
                    case "Server.Pwd":
                        txt_Pwd.Text = item.Attribute("value").Value;
                        break;
                    case "Server.NameSpace":
                        txt_NameSpace.Text = item.Attribute("value").Value;
                        break;
                    case "Server.Path":
                        txt_Path.Text = item.Attribute("value").Value;
                        break;
                    case "Server.DataBaseName":
                        txt_DataBaseName.Text = item.Attribute("value").Value;
                        break;
                }
            }
        }

        /// <summary>
        /// 判断配置文件是否存在或保存配置文件
        /// </summary>
        /// <param name="isReset">为true则重置文件内容</param>
        /// <param name="config">可选参数, 为配置文件里的value值, 需要长度为6的数组</param>
        private void IsConfigExist(bool isReset, params string[] config)
        {
            try
            {
                if (config.Length < 7)
                {
                    config = new string[] { "", "", "", "", "", "" };
                }
                if (!Directory.Exists("../../App_Data"))
                {
                    Directory.CreateDirectory("../../App_Data");
                }
                if (!File.Exists(configPath) || isReset)
                {
                    FileStream fileStream = new FileStream("../../App_Data/CodeAutogenerationTool.xml", FileMode.Create);
                    string configStr = string.Format("<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<configuration>\n  <appSettings>\n    <add key=\"Server.Type\" value=\"{0}\" />\n    <add key=\"Server.Ip\" value=\"{1}\" />\n    <add key=\"Server.UserName\" value=\"{2}\" />\n    <add key=\"Server.Pwd\" value=\"{3}\" />\n    <add key=\"Server.DataBaseName\" value=\"{4}\" />\n    <add key=\"Server.NameSpace\" value=\"{5}\" />\n    <add key=\"Server.Path\" value=\"{6}\" />\n  </appSettings>\n</configuration>", config);
                    byte[] array = Encoding.Default.GetBytes(configStr);
                    fileStream.Write(array, 0, array.Length);
                    fileStream.Close();
                }
            }
            catch (Exception e)
            {
                txt_Msg.Text += e.Message + "\r\n";
            }

        }

        /// <summary>
        /// 连接数据库
        /// </summary>
        private void ConnectionDataBase()
        {
            try
            {
                string dataBaseType = "";
                if (cbb_DataBaseType.InvokeRequired)
                {
                    connDelegate cd = new connDelegate(() =>
                    {
                        dataBaseType = (cbb_DataBaseType.SelectedItem as ListItem).Value;
                    });
                    Invoke(cd);
                }
                switch (dataBaseType)
                {
                    case "0":
                        //MS SQL的数据库连接字符串
                        connStr = string.Format("Data Source={0};Initial Catalog={1};User ID={2};Password={3};Connection Timeout=5", txt_Ip.Text, txt_DataBaseName.Text, txt_UserName.Text, txt_Pwd.Text);
                        break;
                }
                conn = new SqlConnection(connStr);
                conn.Open();//打开数据库连接
                if (btn_Connect.InvokeRequired)
                {
                    connDelegate cd = new connDelegate(ConnectionDelegate);
                    Invoke(cd);
                }
                else
                {
                    ConnectionDelegate();
                }
            }
            catch (Exception e)
            {
                //数据库连接失败 从不是创建控件的线程 委托访问
                if (btn_Connect.InvokeRequired)
                {
                    connDelegate cd = new connDelegate(() =>
                    {
                        btn_Connect.Enabled = true;
                        btn_Connect.Text = "重新连接";
                        txt_Msg.Text += e.Message + "\r\n";
                    });
                    Invoke(cd);
                }
                else
                {
                    btn_Connect.Enabled = true;
                    btn_Connect.Text = "重新连接";
                    txt_Msg.Text += e.Message + "\r\n";
                }
            }
        }

        //该线程无法操作非该线程创建的控件, 使用委托修改指定线程创建的控件
        private void ConnectionDelegate()
        {
            //连接数据库成功
            if (conn.State == ConnectionState.Open)
            {
                cbb_DataBaseType.Enabled = false;
                txt_Ip.Enabled = false;
                txt_UserName.Enabled = false;
                txt_Pwd.Enabled = false;
                txt_DataBaseName.Enabled = false;
                txt_NameSpace.Enabled = false;
                txt_Path.Enabled = false;
                btn_Connect.Enabled = false;
                btn_Connect.Text = "连接成功";
                btn_Close.Enabled = true;
                btn_SelectPath.Enabled = false;
                txt_Msg.Text += DateTime.Now + " 连接数据库成功\r\n";
                MSSqlAutoGenerationHelper.path = txt_Path.Text;//生成代码路径
                MSSqlAutoGenerationHelper.nameSpace = txt_NameSpace.Text;//生成代码的命名空间

                #region 数据库中表名读取
                string[] restrictions = new string[4];
                restrictions[3] = "BASE TABLE";
                DataTable dt = conn.GetSchema("Tables", restrictions);
                List<string> tables = new List<string>();
                foreach (DataRow row in dt.Rows)
                {
                    tables.Add(row["TABLE_NAME"].ToString());
                }
                tables.Sort();
                cbb_Tables.DataSource = tables;
                #endregion
            }
        }

        #endregion

        private void button1_Click(object sender, EventArgs e)
        {
        }
    }
}
